# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

@platformatic/php-node is a Node.js native addon that embeds PHP within the same process as Node.js, enabling seamless communication without network overhead. It's built with Rust using NAPI-RS for safe and performant bindings.

## Essential Commands

### Development
```bash
# Build release version
npm run build

# Build debug version (faster compilation, includes debug symbols)
npm run build:debug

# Run all tests
npm test

# Run specific test file
npx ava __test__/headers.spec.mjs

# Lint JavaScript code  
npm run lint

# Create universal binary (macOS)
npm run universal

# Version bump
npm run version
```

### Rust-specific builds
```bash
# Build with proper rpath for linking libphp
RUSTFLAGS="-C link-args=-Wl,-rpath,\$ORIGIN" npm run build

# Build specific crate
cargo build --manifest-path crates/php_node/Cargo.toml --release
```

## Architecture

### Multi-language Structure
- **Rust** (`/crates`): Core implementation using Cargo workspace
  - `lang_handler`: Generic language handler abstractions
  - `php`: PHP embedding and SAPI implementation  
  - `php_node`: NAPI bindings exposing Rust to Node.js
- **JavaScript**: Node.js API layer (`index.js`, `index.d.ts`)
- **PHP**: Embedded runtime via libphp.{so,dylib}

### Key Components

1. **PHP Class** (`index.js`): Main entry point for creating PHP environments
   - Manages rewriter rules for URL routing
   - Handles request/response lifecycle
   - Supports both sync and async request handling

2. **Request/Response Model**: Web standards-compatible implementation
   - `Request` class with headers, body, method
   - `Response` class with status, headers, body
   - `Headers` class with case-insensitive header handling

3. **Rewriter System**: Apache mod_rewrite-like functionality
   - Conditional rules with regex patterns
   - Environment variable support
   - Rule chaining with [L], [R], [C] flags

4. **SAPI Implementation**: Custom PHP SAPI in Rust
   - Direct Zend API usage for performance
   - Thread-safe with TSRM support
   - Reusable PHP environments across requests

## Critical Development Notes

1. **System Dependencies Required**:
   - Linux: `libssl-dev libcurl4-openssl-dev libxml2-dev libsqlite3-dev libonig-dev re2c libpq5`
   - macOS: `openssl@3 curl sqlite libxml2 oniguruma postgresql@16`

2. **PHP Runtime**: Must have `libphp.so` (Linux) or `libphp.dylib` (macOS) in project root

3. **Testing**: AVA framework with 3-minute timeout due to PHP startup overhead

4. **Type Definitions**: `index.d.ts` is auto-generated by NAPI-RS - do not edit manually

5. **Platform Support**: x64 Linux, x64/arm64 macOS (pre-built binaries in `/npm`)

6. **Recent Architecture Changes**: 
   - `lang_handler` crate no longer uses `napi` features directly (removed from dependencies)
   - `php` crate uses custom fork of ext-php-rs from platformatic GitHub org

## Common Tasks

### Adding New NAPI Functions
1. Implement in Rust under `crates/php_node/src/`
2. Use `#[napi]` attributes for exposed functions/classes
3. Run `npm run build` to regenerate TypeScript definitions

### Modifying Request/Response Handling
- Core logic in `crates/php/src/sapi.rs`
- JavaScript wrapper in `index.js`
- Headers handling in `crates/php_node/src/headers.rs`

### Debugging PHP Issues
- Check INTERNALS.md for PHP embedding details
- Use `npm run build:debug` for debug symbols
- PHP superglobals set via `SG(...)` macro in Rust code

### Working with Rewriter Rules
The rewriter system supports Apache mod_rewrite-like functionality:
- Create rules with conditions (header, host, method, path, query)
- Apply rewriters (header, href, method, path, query, status)
- Use flags like [L] (last), [R] (redirect), [C] (chain)
- Example: `new Rewriter([{ conditions: [{type: 'path', args: ['^/old/(.*)$']}], rewriters: [{type: 'path', args: ['^/old/(.*)$', '/new/$1']}] }])`

## Project Files Reference

- `index.js`: Main JavaScript API, exports PHP, Request, Response, Headers, Rewriter classes
- `crates/php_node/src/lib.rs`: NAPI bindings entry point
- `crates/php/src/sapi.rs`: PHP SAPI implementation (core request handling)
- `crates/lang_handler/src/`: Generic language handler abstractions (request/response/rewriter)
- `__test__/*.spec.mjs`: Test files for each component